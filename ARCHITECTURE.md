# Architettura Autenticazione MyCassa

## ğŸ“ Struttura Componenti

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    app/layout.tsx                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           AuthProvider (Context)                   â”‚  â”‚
â”‚  â”‚  - user state                                      â”‚  â”‚
â”‚  â”‚  - accessToken state                               â”‚  â”‚
â”‚  â”‚  - login(), logout()                               â”‚  â”‚
â”‚  â”‚  - isAuthenticated, isLoading                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                              â”‚
â”‚           â”œâ”€â”€â”€ app/page.tsx (redirect logic)            â”‚
â”‚           â”œâ”€â”€â”€ app/login/page.tsx                       â”‚
â”‚           â””â”€â”€â”€ app/dashboard/page.tsx (protected)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flow di Autenticazione

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚         â”‚  Client  â”‚         â”‚   API    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚
     â”‚  1. Navigate       â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
     â”‚                    â”‚                     â”‚
     â”‚  2. Redirect       â”‚                     â”‚
     â”‚     to /login      â”‚                     â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                    â”‚                     â”‚
     â”‚  3. Enter          â”‚                     â”‚
     â”‚     credentials    â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
     â”‚                    â”‚  4. POST /auth/loginâ”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  5. Response:       â”‚
     â”‚                    â”‚     - user info     â”‚
     â”‚                    â”‚     - accessToken   â”‚
     â”‚                    â”‚     - refreshToken  â”‚
     â”‚                    â”‚       (cookie)      â”‚
     â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  6. Save to storage â”‚
     â”‚                    â”‚     localStorage/   â”‚
     â”‚                    â”‚     sessionStorage  â”‚
     â”‚                    â”‚                     â”‚
     â”‚  7. Redirect to    â”‚                     â”‚
     â”‚     /dashboard     â”‚                     â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                    â”‚                     â”‚
```

## ğŸ” Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚         â”‚Interceptorâ”‚        â”‚   API    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚
     â”‚  1. API Request    â”‚                     â”‚
     â”‚    with expired    â”‚                     â”‚
     â”‚    accessToken     â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
     â”‚                    â”‚  2. Forward request â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  3. 401 Unauthorizedâ”‚
     â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  4. POST /auth/     â”‚
     â”‚                    â”‚     refresh (with   â”‚
     â”‚                    â”‚     refreshToken    â”‚
     â”‚                    â”‚     cookie)         â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  5. New accessToken â”‚
     â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  6. Update storage  â”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  7. Retry original  â”‚
     â”‚                    â”‚     request         â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚  8. Success responseâ”‚
     â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  9. Return data    â”‚                     â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                    â”‚                     â”‚
```

## ğŸ’¾ Storage Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  "Ricordami" ?                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ YES                    â”‚ NO
             â–¼                        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  localStorage   â”‚     â”‚ sessionStorage  â”‚
   â”‚  (persistent)   â”‚     â”‚  (temporary)    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ - user          â”‚     â”‚ - user          â”‚
   â”‚ - accessToken   â”‚     â”‚ - accessToken   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Cookie (HTTP-  â”‚
              â”‚   Only, Secure) â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ - refreshToken  â”‚
              â”‚   (7 days)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›¡ï¸ Sicurezza

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Livelli di Sicurezza                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  1. Input Validation (Zod)                      â”‚
â”‚     âœ“ Schema validation                         â”‚
â”‚     âœ“ Type safety                               â”‚
â”‚                                                  â”‚
â”‚  2. Token Management                            â”‚
â”‚     âœ“ Short-lived access token (15 min)        â”‚
â”‚     âœ“ Long-lived refresh token (7 days)        â”‚
â”‚     âœ“ HTTP-only cookie for refresh             â”‚
â”‚                                                  â”‚
â”‚  3. Network Security                            â”‚
â”‚     âœ“ HTTPS enforced                            â”‚
â”‚     âœ“ CORS with credentials                     â”‚
â”‚     âœ“ Secure cookie flags                       â”‚
â”‚                                                  â”‚
â”‚  4. Client Protection                           â”‚
â”‚     âœ“ Protected routes                          â”‚
â”‚     âœ“ Auto redirect on auth failure            â”‚
â”‚     âœ“ Token auto-refresh                        â”‚
â”‚                                                  â”‚
â”‚  5. Error Handling                              â”‚
â”‚     âœ“ User-friendly messages                    â”‚
â”‚     âœ“ No sensitive data in errors              â”‚
â”‚     âœ“ Proper cleanup on logout                 â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ File Dependencies

```
app/layout.tsx
    â”‚
    â””â”€â–º lib/auth-context.tsx
            â”œâ”€â–º React Context API
            â””â”€â–º fetch API

app/login/page.tsx
    â”œâ”€â–º lib/auth-context.tsx (useAuth)
    â”œâ”€â–º components/ui/* (shadcn)
    â”œâ”€â–º react-hook-form
    â”œâ”€â–º zod
    â””â”€â–º sonner (toast)

app/dashboard/page.tsx
    â”œâ”€â–º lib/auth-context.tsx (useAuth)
    â”œâ”€â–º components/protected-route.tsx
    â””â”€â–º components/ui/*

lib/api-client.ts
    â”œâ”€â–º axios
    â””â”€â–º interceptors

hooks/use-api.ts
    â”œâ”€â–º lib/api-client.ts
    â””â”€â–º lib/api-types.ts
```

## ğŸ¯ API Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            API Endpoints Used                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  POST /auth/login                               â”‚
â”‚  â”‚  Request: { username, password }            â”‚
â”‚  â”‚  Response: { user, accessToken }            â”‚
â”‚  â”‚  Cookie: refreshToken (HTTP-only)           â”‚
â”‚  â”‚                                              â”‚
â”‚  POST /auth/refresh                             â”‚
â”‚  â”‚  Cookie: refreshToken                       â”‚
â”‚  â”‚  Response: { accessToken }                  â”‚
â”‚  â”‚                                              â”‚
â”‚  POST /auth/logout                              â”‚
â”‚  â”‚  Cookie: refreshToken                       â”‚
â”‚  â”‚  Response: 200 OK                           â”‚
â”‚  â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
