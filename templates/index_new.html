<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cassa - Insieme in Festa</title>
  <style>
    :root {
      --radius: 0.65rem;
      --background: oklch(1 0 0);
      --foreground: oklch(0.141 0.005 285.823);
      --card: oklch(1 0 0);
      --card-foreground: oklch(0.141 0.005 285.823);
      --popover: oklch(1 0 0);
      --popover-foreground: oklch(0.141 0.005 285.823);
      --primary: oklch(0.795 0.184 86.047);
      --primary-foreground: oklch(0.421 0.095 57.708);
      --secondary: oklch(0.967 0.001 286.375);
      --secondary-foreground: oklch(0.21 0.006 285.885);
      --muted: oklch(0.967 0.001 286.375);
      --muted-foreground: oklch(0.552 0.016 285.938);
      --accent: oklch(0.967 0.001 286.375);
      --accent-foreground: oklch(0.21 0.006 285.885);
      --destructive: oklch(0.577 0.245 27.325);
      --border: oklch(0.92 0.004 286.32);
      --input: oklch(0.92 0.004 286.32);
      --ring: oklch(0.795 0.184 86.047);
      --sidebar: oklch(0.985 0 0);
      --sidebar-foreground: oklch(0.141 0.005 285.823);
    }
    
    [data-theme="dark"] {
      --background: oklch(0.141 0.005 285.823);
      --foreground: oklch(0.98 0 0);
      --card: oklch(0.18 0.007 285.823);
      --card-foreground: oklch(0.98 0 0);
      --popover: oklch(0.18 0.007 285.823);
      --popover-foreground: oklch(0.98 0 0);
      --primary: oklch(0.795 0.184 86.047);
      --primary-foreground: oklch(0.421 0.095 57.708);
      --secondary: oklch(0.22 0.01 285.823);
      --secondary-foreground: oklch(0.98 0 0);
      --muted: oklch(0.22 0.01 285.823);
      --muted-foreground: oklch(0.65 0.015 285.938);
      --accent: oklch(0.22 0.01 285.823);
      --accent-foreground: oklch(0.98 0 0);
      --destructive: oklch(0.577 0.245 27.325);
      --border: oklch(0.25 0.012 285.82);
      --input: oklch(0.25 0.012 285.82);
      --ring: oklch(0.795 0.184 86.047);
      --sidebar: oklch(0.18 0.007 285.823);
      --sidebar-foreground: oklch(0.98 0 0);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--background);
      color: var(--foreground);
      line-height: 1.5;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .header h1 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--foreground);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn {
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius);
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-icon {
      padding: 0.4rem;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--primary-foreground);
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: var(--secondary-foreground);
    }
    
    .container {
      width: 100%;
      padding: 1rem;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 1rem;
      flex: 1;
      overflow: hidden;
    }
    
    #productsArea {
      overflow-y: auto;
      height: 100%;
      padding-right: 0.5rem;
    }
    
    .category-section {
      margin-bottom: 1.25rem;
    }
    
    .category-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--foreground);
      margin-bottom: 0.6rem;
      padding-bottom: 0.35rem;
      border-bottom: 2px solid var(--primary);
      text-transform: uppercase;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.5rem;
    }
    
    .product-btn {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.65rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      height: 85px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .product-btn:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    .product-btn:active {
      transform: translateY(0);
    }
    
    .product-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--foreground);
      margin-bottom: 0.2rem;
      line-height: 1.2;
    }
    
    .product-price {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .sidebar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      height: 100%;
      overflow-y: auto;
    }
    
    .sidebar-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .form-group {
      margin-bottom: 0.75rem;
    }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--foreground);
    }
    
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: var(--background);
      color: var(--foreground);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--ring);
      box-shadow: 0 0 0 2px rgba(205, 180, 100, 0.1);
    }
    
    .payment-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    
    .payment-btn {
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--foreground);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .payment-btn:hover {
      border-color: var(--primary);
      background: var(--muted);
    }
    
    .payment-btn.active {
      background: var(--primary);
      color: var(--primary-foreground);
      border-color: var(--primary);
      font-weight: 600;
    }
    
    .cart-list {
      margin: 0.75rem 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 0;
    }
    
    .cart-empty {
      text-align: center;
      color: var(--muted-foreground);
      padding: 2rem 0;
      font-size: 0.875rem;
    }
    
    .cart-item {
      padding: 0.75rem;
      background: var(--muted);
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }
    
    .cart-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }
    
    .cart-item-name {
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .cart-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .qty-btn {
      width: 1.5rem;
      height: 1.5rem;
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      background: var(--card);
      color: var(--foreground);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .qty-btn:hover {
      background: var(--muted);
      border-color: var(--primary);
    }
    
    .qty-display {
      min-width: 2rem;
      text-align: center;
      font-weight: 500;
    }
    
    .btn-remove {
      background: transparent;
      border: none;
      color: var(--destructive);
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0;
      width: 1.5rem;
      height: 1.5rem;
    }
    
    .total-section {
      background: var(--muted);
      padding: 0.75rem;
      border-radius: var(--radius);
      margin-bottom: 0.75rem;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      font-size: 1.125rem;
      font-weight: 700;
    }
    
    .btn-generate {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary);
      color: var(--primary-foreground);
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-generate:hover {
      opacity: 0.9;
    }
    
    .btn-generate:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-download {
      width: 100%;
      padding: 0.75rem;
      background: var(--card);
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }
    
    .btn-download:hover {
      background: var(--primary);
      color: var(--primary-foreground);
    }
    
    .checkbox-group {
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      background: var(--muted);
      border-radius: var(--radius);
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }
    
    .checkbox-item span {
      font-size: 0.875rem;
      color: var(--foreground);
    }
    
    .alert {
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      margin-top: 1rem;
      font-size: 0.875rem;
    }
    
    .alert-success {
      background: var(--primary);
      color: var(--primary-foreground);
    }
    
    .alert-error {
      background: var(--destructive);
      color: white;
    }
    
    #orderCode {
      text-transform: uppercase;
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--muted-foreground);
    }
    
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: relative;
        top: 0;
      }
    }
    
    @media (max-width: 640px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .product-btn {
        height: 90px;
        padding: 0.75rem;
      }
      
      .product-name {
        font-size: 0.75rem;
      }
      
      .product-price {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>🍕Insieme in Festa</h1>
  <div class="header-actions">
    <a href="{{ url_for('printer_config') }}" class="btn btn-secondary" title="Configurazione Stampanti">🖨️</a>
    <button id="themeToggle" class="btn btn-secondary btn-icon" title="Toggle Dark Mode">
      <span id="themeIcon">🌙</span>
    </button>
    <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
  </div>
</div>

<div class="container">
  <div class="grid">
    <!-- Products Area -->
    <div id="productsArea">
      <div class="loading">Caricamento prodotti...</div>
    </div>

    <!-- Sidebar Cart -->
    <div class="sidebar">
      <div class="sidebar-title">🛒 Carrello</div>

      <!-- Load Order by Code -->
      <div class="form-group">
        <label class="form-label">Carica Ordine</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="orderCode" class="form-input" placeholder="Codice ordine (es. ABC)" maxlength="3" style="flex: 1; text-transform: uppercase;">
          <button type="button" class="btn btn-primary" onclick="loadOrder()" style="white-space: nowrap;">🔍 Cerca</button>
        </div>
        <div id="orderLoadResult" style="margin-top: 0.5rem;"></div>
      </div>

      <!-- Order Info -->
      <div class="form-group">
        <label class="form-label">Tavolo *</label>
        <input type="text" id="tavolo" class="form-input" placeholder="Es. 12 o Tavolo A5">
      </div>

      <div class="form-group">
        <label class="form-label">Cliente *</label>
        <input type="text" id="cliente" class="form-input" placeholder="Es. Mario Rossi">
      </div>

      <!-- Cart List -->
      <div class="cart-list" id="cartList">
        <div class="cart-empty">Carrello vuoto</div>
      </div>

      <!-- Total -->
      <div class="total-section">
        <div class="total-row">
          <span>TOTALE:</span>
          <span id="totalAmount">0,00 {{ cfg.currency }}</span>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="form-group">
        <label class="form-label">Metodo Pagamento *</label>
        <div class="payment-group">
          <button type="button" class="payment-btn" data-value="CONTANTI" onclick="selectPayment('CONTANTI')">
            💵 Contanti
          </button>
          <button type="button" class="payment-btn" data-value="POS" onclick="selectPayment('POS')">
            💳 POS
          </button>
        </div>
      </div>

      <!-- Change Calculator (visible only for cash) -->
      <div id="changeCalculator" style="display: none; margin-bottom: 1rem;">
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <label class="form-label">Pagato dal cliente</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="number" id="pagatoCliente" class="form-input" step="0.01" min="0" placeholder="0.00" style="flex: 1;">
            <span style="font-weight: 500; color: var(--muted-foreground);">{{ cfg.currency }}</span>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Resto</label>
          <input type="text" id="restoCalcolato" class="form-input" value="0,00 {{ cfg.currency }}" readonly style="background: var(--muted); font-weight: 600;">
        </div>
      </div>

      <!-- Print Option -->
      <div class="checkbox-group">
        <label class="checkbox-item">
          <input type="checkbox" id="autoPrint" checked>
          <span>Stampa automatica (ESC/POS)</span>
        </label>
      </div>

      <!-- Generate Button -->
      <button id="btnGenerate" class="btn-generate">Crea Ordine</button>

      <div id="result"></div>
    </div>
  </div>
</div>

<script>
const currency = '{{ cfg.currency }}';
const cart = [];
let categories = [];
let foodsByCategory = {};
let isLoading = false; // Previene chiamate duplicate
let selectedPayment = null; // Metodo di pagamento selezionato

// Load order by code
async function loadOrder() {
  const codeInput = document.getElementById('orderCode');
  const resultEl = document.getElementById('orderLoadResult');
  const code = codeInput.value.trim().toUpperCase();
  
  if (!code || code.length !== 3) {
    resultEl.innerHTML = '<small style="color: var(--destructive);">⚠️ Inserisci un codice di 3 caratteri</small>';
    return;
  }
  
  resultEl.innerHTML = '<small style="color: var(--muted-foreground);">🔄 Ricerca in corso...</small>';
  
  try {
    const resp = await fetch(`/api/orders/${code}`);
    const data = await resp.json();
    
    if (resp.ok && data.success) {
      const order = data.order;
      
      // Clear current cart
      cart.length = 0;
      
      // Load order items into cart
      if (order.foodsOrdered && order.foodsOrdered.length > 0) {
        for (const item of order.foodsOrdered) {
          const categoryName = item.food.category.name || 'N/A';
          const categoryObj = categories.find(c => c.name === categoryName);
          const categoryId = categoryObj ? categoryObj.id : 999;
          
          cart.push({
            id: item.food.id,
            name: item.food.name || 'Prodotto',
            price: parseFloat(item.food.price) || 0,
            category: categoryName,
            categoryId: categoryId,
            qty: item.quantity
          });
        }
      }
      
      // Fill form fields
      document.getElementById('tavolo').value = order.table || '';
      document.getElementById('cliente').value = order.customer || '';
      
      // Set payment method
      if (order.paymentMethod) {
        selectPayment(order.paymentMethod);
      }
      
      updateUI();
      resultEl.innerHTML = `<small style="color: var(--primary); font-weight: 600;">✅ Ordine ${code} caricato!</small>`;
      codeInput.value = '';
    } else {
      resultEl.innerHTML = '<small style="color: var(--destructive); font-weight: 600;">❌ Codice ordine non trovato</small>';
    }
  } catch (err) {
    console.error('Error loading order:', err);
    resultEl.innerHTML = '<small style="color: var(--destructive);">❌ Errore di connessione</small>';
  }
}

// Select payment method
function selectPayment(method) {
  selectedPayment = method;
  document.querySelectorAll('.payment-btn').forEach(btn => {
    if (btn.dataset.value === method) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Show/hide change calculator based on payment method
  const calculator = document.getElementById('changeCalculator');
  if (method === 'CONTANTI') {
    calculator.style.display = 'block';
    updateChange();
  } else {
    calculator.style.display = 'none';
  }
}

// Fetch categories
async function loadCategories() {
  if (isLoading) {
    console.log('Already loading, skipping...');
    return;
  }
  
  isLoading = true;
  try {
    const resp = await fetch('/api/categories');
    const data = await resp.json();
    
    if (data.success) {
      categories = data.categories;
      await loadAllFoods();
      renderProducts();
    } else {
      showError('Errore caricamento categorie: ' + (data.error || 'Sconosciuto'));
    }
  } catch (err) {
    console.error('Error loading categories:', err);
    showError('Errore di connessione: ' + err.message);
  } finally {
    isLoading = false;
  }
}

// Fetch foods for all categories with delay to avoid rate limiting
async function loadAllFoods() {
  // Carica sequenzialmente con un piccolo delay per evitare rate limit
  for (const cat of categories) {
    try {
      const resp = await fetch(`/api/foods/category/${cat.id}`);
      const data = await resp.json();
      
      if (data.success) {
        foodsByCategory[cat.id] = data.foods;
      } else {
        console.error(`Error loading foods for ${cat.name}:`, data.error);
      }
      
      // Piccolo delay tra le richieste per evitare 429
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (err) {
      console.error(`Errore caricamento cibi categoria ${cat.name}:`, err);
    }
  }
}

// Render products by category
function renderProducts() {
  const area = document.getElementById('productsArea');
  if (categories.length === 0) {
    area.innerHTML = '<div class="loading">Nessuna categoria disponibile</div>';
    return;
  }

  let html = '';
  for (const cat of categories) {
    const foods = foodsByCategory[cat.id] || [];
    if (foods.length === 0) continue;

    html += `
      <div class="category-section">
        <div class="category-title">${cat.name}</div>
        <div class="products-grid">
    `;

    for (const food of foods) {
      const price = parseFloat(food.price) || 0;
      html += `
        <button class="product-btn" onclick="addProduct(${food.id}, '${food.name.replace(/'/g, "\\'")}', ${price}, '${cat.name}')">
          <div class="product-name">${food.name}</div>
          <div class="product-price">${price.toFixed(2)} ${currency}</div>
        </button>
      `;
    }

    html += `
        </div>
      </div>
    `;
  }

  area.innerHTML = html || '<div class="loading">Nessun prodotto disponibile</div>';
}

// Add product to cart
function addProduct(id, name, price, category) {
  const idx = cart.findIndex(x => x.id === id);
  if (idx >= 0) {
    cart[idx].qty++;
  } else {
    // Find category ID for sorting
    const categoryObj = categories.find(c => c.name === category);
    const categoryId = categoryObj ? categoryObj.id : 999;
    cart.push({ id, name, price, category, categoryId, qty: 1 });
  }
  updateUI();
}

// Update cart UI
function updateUI() {
  // Update cart list
  const listEl = document.getElementById('cartList');
  if (cart.length === 0) {
    listEl.innerHTML = '<div class="cart-empty">Carrello vuoto</div>';
  } else {
    // Sort cart by category ID before displaying
    const sortedCart = [...cart].sort((a, b) => {
      const catIdA = a.categoryId || 999;
      const catIdB = b.categoryId || 999;
      return catIdA - catIdB;
    });
    
    // Create a map to find original indices for actions
    const originalIndices = new Map();
    sortedCart.forEach(sortedItem => {
      const originalIdx = cart.findIndex(c => c === sortedItem);
      originalIndices.set(sortedItem, originalIdx);
    });
    
    listEl.innerHTML = sortedCart.map(item => {
      const idx = originalIndices.get(item);
      return `
      <div class="cart-item">
        <div class="cart-item-header">
          <div>
            <div class="cart-item-name">${item.name}</div>
            <small style="color: var(--muted-foreground)">${item.category}</small>
          </div>
          <button class="btn-remove" onclick="removeItem(${idx})" title="Rimuovi">×</button>
        </div>
        <div class="cart-item-footer">
          <div class="qty-controls">
            <button class="qty-btn" onclick="decreaseQty(${idx})">-</button>
            <span class="qty-display">${item.qty}</span>
            <button class="qty-btn" onclick="increaseQty(${idx})">+</button>
          </div>
          <div style="font-weight: 600">${(item.price * item.qty).toFixed(2)} ${currency}</div>
        </div>
      </div>
    `;
    }).join('');
  }

  // Update total
  const total = cart.reduce((sum, it) => sum + (it.price * it.qty), 0);
  document.getElementById('totalAmount').textContent = `${total.toFixed(2)} ${currency}`;
  
  // Update change if payment is cash
  updateChange();
}

// Calculate and update change
function updateChange() {
  if (selectedPayment !== 'CONTANTI') return;
  
  const total = cart.reduce((sum, it) => sum + (it.price * it.qty), 0);
  const paid = parseFloat(document.getElementById('pagatoCliente').value || '0');
  const change = Math.max(0, paid - total);
  
  document.getElementById('restoCalcolato').value = `${change.toFixed(2)} ${currency}`;
}

function removeItem(idx) {
  cart.splice(idx, 1);
  updateUI();
}

function increaseQty(idx) {
  cart[idx].qty++;
  updateUI();
}

function decreaseQty(idx) {
  if (cart[idx].qty > 1) {
    cart[idx].qty--;
  } else {
    cart.splice(idx, 1);
  }
  updateUI();
}

// Generate order
document.getElementById('btnGenerate').addEventListener('click', async () => {
  const resEl = document.getElementById('result');
  const tavolo = document.getElementById('tavolo').value.trim();
  const cliente = document.getElementById('cliente').value.trim();

  if (!tavolo || !cliente) {
    resEl.innerHTML = '<div class="alert alert-error">Inserisci tavolo e cliente</div>';
    return;
  }
  if (!selectedPayment) {
    resEl.innerHTML = '<div class="alert alert-error">Seleziona metodo di pagamento</div>';
    return;
  }
  if (cart.length === 0) {
    resEl.innerHTML = '<div class="alert alert-error">Carrello vuoto</div>';
    return;
  }

  resEl.innerHTML = '<div class="alert">Creazione ordine...</div>';
  const autoPrint = document.getElementById('autoPrint').checked;

  try {
    const resp = await fetch('/genera', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cart: cart,
        currency: currency,
        auto_print: autoPrint,
        tavolo: tavolo,
        cliente: cliente,
        pagamento: selectedPayment
      })
    });

    const js = await resp.json();
    if (!resp.ok || !js.ok) {
      resEl.innerHTML = `<div class="alert alert-error">${js.error || 'Errore generazione'}</div>`;
      return;
    }

    resEl.innerHTML = `<div class="alert alert-success">✅ Ordine ${js.codice_ordine} creato! Totale: ${js.totale_generale.toFixed(2)} ${currency}</div>`;

    // Create download button for ZIP
    const hex = js.zip_base64;
    const bytes = new Uint8Array(hex.length / 2);
    for (let i = 0; i < bytes.length; i++) bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
    const blob = new Blob([bytes], { type: 'application/zip' });
    const url = URL.createObjectURL(blob);
    const btnDownload = document.createElement('button');
    btnDownload.className = 'btn-download';
    btnDownload.textContent = '📥 Scarica scontrini (HTML)';
    btnDownload.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'scontrini_html.zip';
      a.click();
    };
    resEl.appendChild(btnDownload);

    // Reset cart
    cart.length = 0;
    document.getElementById('tavolo').value = '';
    document.getElementById('cliente').value = '';
    document.getElementById('pagatoCliente').value = '';
    selectedPayment = null;
    document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('changeCalculator').style.display = 'none';
    updateUI();
  } catch (err) {
    resEl.innerHTML = `<div class="alert alert-error">Errore: ${err}</div>`;
  }
});

function showError(msg) {
  document.getElementById('productsArea').innerHTML = `<div class="loading" style="color: var(--destructive)">${msg}</div>`;
}

// Update change when paid amount changes
document.getElementById('pagatoCliente').addEventListener('input', updateChange);

// Dark mode toggle
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const html = document.documentElement;

// Check for saved theme preference or default to light mode
const currentTheme = localStorage.getItem('theme') || 'light';
html.setAttribute('data-theme', currentTheme);
themeIcon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';

themeToggle.addEventListener('click', () => {
  const theme = html.getAttribute('data-theme');
  const newTheme = theme === 'light' ? 'dark' : 'light';
  
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
});

// Initialize
loadCategories();
updateUI();
</script>
</body>
</html>
